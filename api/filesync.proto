syntax = "proto3";

package filesync;

option go_package = "github.com/synchme/internal/proto/filesync;filesync";

/**
 * Core Service for File Synchronization
*/
service FileSynchService {

    // Client pushes notification to the server, the server relays to interested clients
    rpc Sync (stream SyncMessage) returns (stream SyncMessage);
}

// -------- Messages ---------

// A generic wrapper for messages in the stream
message SyncMessage {
    oneof msg {
        ClientHello hello  = 1;
        FileUpdate  update = 2;
        FileRename  rename = 3;
        FileRemove  remove = 4;
        SyncAck     ack    = 5;
    }
}

// Sent by the client when it connects after authentication
message ClientHello {
    string client_id = 1;                 // Unique ID for the client (client-side generation)
    repeated string subscribed_paths = 2; // List of paths it wants to sync
}

// Metadata for the message
message MessageMeta {
    string origin_client = 1; // The client ID originating the sync
    int64  version       = 2; // Monotonically increasing version
    int64  timestamp     = 3; // The timestamp (nanoseconds) of the update
}

// Represents a file update (new or modified file)
message FileUpdate {
    MessageMeta meta         = 1; // Message meta data (common data)
    string      path         = 2; // The file/folder path subject to this update
    bytes       data         = 3; // Raw data (diffs) or just chunks (if the message is too large)
    bool        is_chunk     = 4; // If the data contains a chunk
    int32       chunk_index  = 5; // The index of the current chunk
    int32       total_chunks = 6; // Total number of chunks
    bool        is_folder    = 7; // If the current path is a folder or a file
}

// Represents a move/rename operations for a file or a folder
message FileRename {
    MessageMeta meta     = 1; // Message meta data (common data)
    string      path     = 2; // The file/folder path subject to this update
    string      old_path = 3; // The old path of the current file/folder
}

// Represents a delete operation on file or a folder
message FileRemove {
    MessageMeta meta = 1; // Message meta data (common data)
    string      path = 2; // The file/folder path subject to this update
}

// Acknowledgment of the received update
message SyncAck {
    string path        = 1; // The path relative to the ackd update
    int64  timestamp   = 2; // The timestamp of the acknowledgment
    int64  version     = 3; // The version of the file
    string from_client = 4; // The client sendind the ack
    string to_client   = 5; // The origin client that sent the update
}